<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïâÔ∏è Rig Veda Mood Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Serif+Devanagari:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0A0E27 0%, #1a1f3a 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
            padding: 1rem 2rem;
        }

        #title {
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
            color: #D4AF37;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        #search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        #search-input {
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        #search-input:focus {
            border-color: #D4AF37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        #search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        #autocomplete-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .autocomplete-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .autocomplete-item:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-label {
            font-weight: 600;
            color: #D4AF37;
        }

        .autocomplete-count {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        #viz-container {
            position: fixed;
            top: 140px;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: grab;
        }

        #viz-container:active {
            cursor: grabbing;
        }

        #network-controls {
            position: fixed;
            top: 160px;
            right: 2rem;
            z-index: 90;
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #D4AF37;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }

        #legend {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 90;
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 1rem;
            min-width: 200px;
        }

        .legend-title {
            font-weight: 600;
            color: #D4AF37;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.8);
        }

        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        #modal {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 31, 58, 0.95) 100%);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        #modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            color: #D4AF37;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #modal-close:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: rotate(90deg);
        }

        #modal-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #D4AF37;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        #modal-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .tag-pill {
            padding: 0.5rem 1rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            font-size: 0.875rem;
            color: #D4AF37;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tag-pill:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }

        #modal-devanagari {
            font-family: 'Noto Serif Devanagari', serif;
            font-size: 1.75rem;
            text-align: center;
            margin-bottom: 1.5rem;
            line-height: 1.8;
            color: #fff;
        }

        #modal-transliteration {
            font-style: italic;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1.5rem;
            font-size: 1.125rem;
        }

        #modal-translation {
            text-align: center;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2rem;
            font-size: 1.125rem;
        }

        #modal-nav {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            color: #D4AF37;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #tooltip {
            position: absolute;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0A0E27 0%, #1a1f3a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        #loading-spinner {
            font-size: 4rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #loading-text {
            margin-top: 1rem;
            font-size: 1.25rem;
            color: #D4AF37;
        }

        #error {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0A0E27 0%, #1a1f3a 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 2rem;
        }

        #error-message {
            font-size: 1.5rem;
            color: #D4AF37;
            margin-bottom: 2rem;
            text-align: center;
        }

        #retry-btn {
            padding: 1rem 2rem;
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid #D4AF37;
            border-radius: 12px;
            color: #D4AF37;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        #retry-btn:hover {
            background: rgba(212, 175, 55, 0.3);
            transform: scale(1.05);
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: drop-shadow(0 0 8px currentColor);
        }

        .link {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 1px;
            transition: all 0.3s ease;
        }

        .link.active {
            stroke: #D4AF37;
            stroke-width: 2px;
            filter: drop-shadow(0 0 4px #D4AF37);
        }

        .node-label {
            font-size: 11px;
            fill: rgba(255, 255, 255, 0.9);
            pointer-events: none;
            text-anchor: middle;
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
        }

        .pulse {
            animation: pulse 0.6s ease-in-out 3;
        }

        @media (max-width: 768px) {
            #title {
                font-size: 1.25rem;
            }

            #search-input {
                font-size: 0.875rem;
                padding: 0.625rem 1rem;
            }

            #legend {
                bottom: 1rem;
                left: 1rem;
                padding: 0.75rem;
                min-width: 150px;
            }

            .legend-title {
                font-size: 0.75rem;
            }

            .legend-label {
                font-size: 0.75rem;
            }

            #network-controls {
                top: 140px;
                right: 1rem;
            }

            #modal {
                padding: 1.5rem;
                border-radius: 16px;
            }

            #modal-devanagari {
                font-size: 1.5rem;
            }

            #modal-transliteration {
                font-size: 1rem;
            }

            #modal-translation {
                font-size: 1rem;
            }

            .nav-btn {
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.5);
        }
    </style>
</head>
<body>
    <div id="loading">
        <div id="loading-spinner">üïâÔ∏è</div>
        <div id="loading-text">Loading Rig Veda...</div>
    </div>

    <div id="error">
        <div id="error-message">Unable to load data. Please refresh.</div>
        <button id="retry-btn">Retry</button>
    </div>

    <div id="header">
        <h1 id="title">üïâÔ∏è Rig Veda Mood Explorer</h1>
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search by deity, mood, or tag...">
            <div id="autocomplete-dropdown"></div>
        </div>
    </div>

    <div id="viz-container">
        <svg id="network-svg"></svg>
    </div>

    <div id="network-controls">
        <button class="control-btn" id="zoom-in">+</button>
        <button class="control-btn" id="zoom-out">‚àí</button>
        <button class="control-btn" id="reset-view">‚Ü∫</button>
    </div>

    <div id="legend">
        <div class="legend-title">Legend</div>
        <div class="legend-item">
            <div class="legend-circle" style="background: linear-gradient(135deg, #ff6b6b, #ff8e53);"></div>
            <div class="legend-label">Deities</div>
        </div>
        <div class="legend-item">
            <div class="legend-circle" style="background: linear-gradient(135deg, #ffd93d, #f6c344);"></div>
            <div class="legend-label">Moods</div>
        </div>
        <div class="legend-item">
            <div class="legend-circle" style="background: linear-gradient(135deg, #6bcfff, #4da8da);"></div>
            <div class="legend-label">Tags</div>
        </div>
        <div class="legend-item">
            <div class="legend-circle" style="background: #fff; border: 2px solid #D4AF37;"></div>
            <div class="legend-label">Verses</div>
        </div>
    </div>

    <div id="modal-backdrop">
        <div id="modal">
            <div id="modal-close">√ó</div>
            <div id="modal-header"></div>
            <div id="modal-tags"></div>
            <div id="modal-devanagari"></div>
            <div id="modal-transliteration"></div>
            <div id="modal-translation"></div>
            <div id="modal-nav">
                <button class="nav-btn" id="prev-btn">‚Üê Previous</button>
                <button class="nav-btn" id="random-btn">üé≤ Random</button>
                <button class="nav-btn" id="next-btn">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <div id="tooltip"></div>

    <script>
        let data = [];
        let nodes = [];
        let links = [];
        let simulation;
        let svg, g, link, node, label, zoom;
        let searchIndex = [];
        let selectedNode = null;
        let currentVerseIndex = -1;

        async function init() {
            try {
                const response = await fetch('./rigveda_data_augmented.json');
                if (!response.ok) throw new Error('Failed to load data');
                
                const text = await response.text();
                data = JSON.parse(text);

                // Ensure data is an array
                if (!Array.isArray(data)) {
                    throw new Error('Data must be an array');
                }

                data.sort((a, b) => {
                    if (a.mandala !== b.mandala) return a.mandala - b.mandala;
                    if (a.sukta !== b.sukta) return a.sukta - b.sukta;
                    return a.verse - b.verse;
                });

                createGraph();
                buildSearchIndex();
                setupEventListeners();
                initializeVisualization();

                document.getElementById('loading').style.display = 'none';

                if (window.innerWidth < 768) {
                    setupMobileDrift();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'flex';
                document.getElementById('error-message').textContent = 
                    `Unable to load data: ${error.message}`;
            }
        }

        function createGraph() {
            const deityMap = new Map();
            const moodMap = new Map();
            const tagMap = new Map();

            data.forEach((verse, index) => {
                const verseNode = {
                    id: `verse-${index}`,
                    type: 'verse',
                    verseIndex: index,
                    data: verse
                };
                nodes.push(verseNode);

                if (verse.deity) {
                    if (!deityMap.has(verse.deity)) {
                        const deityNode = {
                            id: `deity-${verse.deity}`,
                            type: 'deity',
                            label: verse.deity,
                            count: 0
                        };
                        deityMap.set(verse.deity, deityNode);
                        nodes.push(deityNode);
                    }
                    deityMap.get(verse.deity).count++;
                    links.push({
                        source: `deity-${verse.deity}`,
                        target: verseNode.id
                    });
                }

                if (verse.mood) {
                    if (!moodMap.has(verse.mood)) {
                        const moodNode = {
                            id: `mood-${verse.mood}`,
                            type: 'mood',
                            label: verse.mood,
                            count: 0
                        };
                        moodMap.set(verse.mood, moodNode);
                        nodes.push(moodNode);
                    }
                    moodMap.get(verse.mood).count++;
                    links.push({
                        source: `mood-${verse.mood}`,
                        target: verseNode.id
                    });
                }

                if (verse.tags && Array.isArray(verse.tags) && verse.tags.length > 0) {
                    verse.tags.forEach(tag => {
                        if (!tagMap.has(tag)) {
                            const tagNode = {
                                id: `tag-${tag}`,
                                type: 'tag',
                                label: tag,
                                count: 0
                            };
                            tagMap.set(tag, tagNode);
                            nodes.push(tagNode);
                        }
                        tagMap.get(tag).count++;
                        links.push({
                            source: `tag-${tag}`,
                            target: verseNode.id
                        });
                    });
                }
            });
        }

        function buildSearchIndex() {
            const indexSet = new Set();
            nodes.forEach(node => {
                if (node.type !== 'verse') {
                    indexSet.add(JSON.stringify({
                        type: node.type,
                        label: node.label,
                        id: node.id,
                        count: node.count
                    }));
                }
            });
            searchIndex = Array.from(indexSet).map(item => JSON.parse(item));
        }

        function initializeVisualization() {
            const container = document.getElementById('viz-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select('#network-svg')
                .attr('width', width)
                .attr('height', height);

            zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);
            g = svg.append('g');

            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links)
                    .id(d => d.id)
                    .distance(d => d.target.type === 'verse' ? 30 : 100))
                .force('charge', d3.forceManyBody()
                    .strength(d => {
                        if (d.type === 'verse') return -10;
                        if (d.type === 'deity') return -200;
                        if (d.type === 'mood') return -150;
                        return -100;
                    }))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => {
                    if (d.type === 'verse') return 8;
                    if (d.type === 'deity') return 20;
                    if (d.type === 'mood') return 18;
                    return 15;
                }));

            link = g.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', 'link');

            node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('class', 'node')
                .attr('r', d => {
                    if (d.type === 'verse') return 5;
                    if (d.type === 'deity') return 12;
                    if (d.type === 'mood') return 10;
                    return 8;
                })
                .attr('fill', d => {
                    if (d.type === 'deity') return 'url(#deity-gradient)';
                    if (d.type === 'mood') return 'url(#mood-gradient)';
                    if (d.type === 'tag') return 'url(#tag-gradient)';
                    return '#fff';
                })
                .attr('stroke', d => d.type === 'verse' ? '#D4AF37' : 'none')
                .attr('stroke-width', d => d.type === 'verse' ? 1.5 : 0)
                .on('mouseenter', handleNodeHover)
                .on('mouseleave', handleNodeLeave)
                .on('click', handleNodeClick)
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded));

            label = g.append('g')
                .selectAll('text')
                .data(nodes.filter(d => d.type !== 'verse'))
                .join('text')
                .attr('class', 'node-label')
                .attr('dy', d => {
                    if (d.type === 'deity') return 20;
                    if (d.type === 'mood') return 18;
                    return 16;
                })
                .text(d => d.label);

            const defs = svg.append('defs');

            const deityGradient = defs.append('linearGradient')
                .attr('id', 'deity-gradient')
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '100%').attr('y2', '100%');
            deityGradient.append('stop').attr('offset', '0%').attr('stop-color', '#ff6b6b');
            deityGradient.append('stop').attr('offset', '100%').attr('stop-color', '#ff8e53');

            const moodGradient = defs.append('linearGradient')
                .attr('id', 'mood-gradient')
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '100%').attr('y2', '100%');
            moodGradient.append('stop').attr('offset', '0%').attr('stop-color', '#ffd93d');
            moodGradient.append('stop').attr('offset', '100%').attr('stop-color', '#f6c344');

            const tagGradient = defs.append('linearGradient')
                .attr('id', 'tag-gradient')
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '100%').attr('y2', '100%');
            tagGradient.append('stop').attr('offset', '0%').attr('stop-color', '#6bcfff');
            tagGradient.append('stop').attr('offset', '100%').attr('stop-color', '#4da8da');

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        function handleNodeHover(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('r', () => {
                    if (d.type === 'verse') return 7;
                    if (d.type === 'deity') return 14;
                    if (d.type === 'mood') return 12;
                    return 10;
                });

            const tooltip = document.getElementById('tooltip');
            if (d.type !== 'verse') {
                tooltip.innerHTML = `<strong>${d.label}</strong><br>${d.count} verses`;
                tooltip.style.display = 'block';
                tooltip.style.left = (event.pageX + 10) + 'px';
                tooltip.style.top = (event.pageY + 10) + 'px';
            }
        }

        function handleNodeLeave(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('r', () => {
                    if (d.type === 'verse') return 5;
                    if (d.type === 'deity') return 12;
                    if (d.type === 'mood') return 10;
                    return 8;
                });

            document.getElementById('tooltip').style.display = 'none';
        }

        function handleNodeClick(event, d) {
            event.stopPropagation();

            if (d.type === 'verse') {
                openVerseModal(d.verseIndex);
            } else {
                if (selectedNode === d.id) {
                    resetNetworkView();
                } else {
                    selectNode(d);
                }
            }
        }

        function selectNode(d) {
            selectedNode = d.id;

            const selectedCircle = node.filter(n => n.id === d.id);
            selectedCircle.classed('pulse', true);
            setTimeout(() => selectedCircle.classed('pulse', false), 1800);

            const connectedIds = new Set();
            connectedIds.add(d.id);
            
            links.forEach(link => {
                if (link.source.id === d.id || link.source === d.id) {
                    connectedIds.add(typeof link.target === 'object' ? link.target.id : link.target);
                }
                if (link.target.id === d.id || link.target === d.id) {
                    connectedIds.add(typeof link.source === 'object' ? link.source.id : link.source);
                }
            });

            node.transition()
                .duration(300)
                .style('opacity', n => connectedIds.has(n.id) ? 1 : 0.1);

            label.transition()
                .duration(300)
                .style('opacity', n => connectedIds.has(n.id) ? 1 : 0.1);

            link.classed('active', false)
                .transition()
                .duration(300)
                .style('opacity', l => {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    if (sourceId === d.id || targetId === d.id) {
                        return 1;
                    }
                    return 0.02;
                });

            link.each(function(l) {
                const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                if (sourceId === d.id || targetId === d.id) {
                    d3.select(this).classed('active', true);
                }
            });

            const bbox = {
                x: d.x - 200,
                y: d.y - 200,
                width: 400,
                height: 400
            };
            zoomToBbox(bbox);
        }

        function resetNetworkView() {
            selectedNode = null;

            node.transition()
                .duration(300)
                .style('opacity', 1);

            label.transition()
                .duration(300)
                .style('opacity', 1);

            link.classed('active', false)
                .transition()
                .duration(300)
                .style('opacity', 1);
        }

        function zoomToBbox(bbox) {
            const container = document.getElementById('viz-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const dx = bbox.width;
            const dy = bbox.height;
            const x = bbox.x + dx / 2;
            const y = bbox.y + dy / 2;
            const scale = Math.min(8, 0.9 / Math.max(dx / width, dy / height));
            const translate = [width / 2 - scale * x, height / 2 - scale * y];

            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }

        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function openVerseModal(verseIndex) {
            currentVerseIndex = verseIndex;
            const verse = data[verseIndex];

            document.getElementById('modal-header').textContent = 
                `Mandala ${verse.mandala} ‚Ä¢ Sukta ${verse.sukta} ‚Ä¢ Verse ${verse.verse}`;

            const tagsContainer = document.getElementById('modal-tags');
            tagsContainer.innerHTML = '';

            if (verse.deity) {
                const pill = document.createElement('div');
                pill.className = 'tag-pill';
                pill.textContent = verse.deity;
                pill.dataset.nodeId = `deity-${verse.deity}`;
                pill.onclick = () => handleTagClick(pill.dataset.nodeId);
                tagsContainer.appendChild(pill);
            }

            if (verse.mood) {
                const pill = document.createElement('div');
                pill.className = 'tag-pill';
                pill.textContent = verse.mood;
                pill.dataset.nodeId = `mood-${verse.mood}`;
                pill.onclick = () => handleTagClick(pill.dataset.nodeId);
                tagsContainer.appendChild(pill);
            }

            if (verse.tags && Array.isArray(verse.tags) && verse.tags.length > 0) {
                verse.tags.forEach(tag => {
                    const pill = document.createElement('div');
                    pill.className = 'tag-pill';
                    pill.textContent = tag;
                    pill.dataset.nodeId = `tag-${tag}`;
                    pill.onclick = () => handleTagClick(pill.dataset.nodeId);
                    tagsContainer.appendChild(pill);
                });
            }

            const devanagariText = verse.devanagari || '';
            document.getElementById('modal-devanagari').textContent = devanagariText;
            
            const transliterationText = (verse.transliteration || '').replace(/<BR>/gi, ' ');
            document.getElementById('modal-transliteration').textContent = transliterationText;
            
            document.getElementById('modal-translation').textContent = verse.translation_griffith || '';

            document.getElementById('prev-btn').disabled = verseIndex === 0;
            document.getElementById('next-btn').disabled = verseIndex === data.length - 1;

            document.getElementById('modal-backdrop').style.display = 'flex';
        }

        function closeVerseModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
            currentVerseIndex = -1;
        }

        function handleTagClick(nodeId) {
            closeVerseModal();
            const targetNode = nodes.find(n => n.id === nodeId);
            if (targetNode) {
                selectNode(targetNode);
            }
        }

        function navigateToPrevious() {
            if (currentVerseIndex > 0) {
                openVerseModal(currentVerseIndex - 1);
            }
        }

        function navigateToNext() {
            if (currentVerseIndex < data.length - 1) {
                openVerseModal(currentVerseIndex + 1);
            }
        }

        function navigateToRandom() {
            const randomIndex = Math.floor(Math.random() * data.length);
            openVerseModal(randomIndex);
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            const autocompleteDropdown = document.getElementById('autocomplete-dropdown');

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();

                if (query.length < 2) {
                    autocompleteDropdown.style.display = 'none';
                    return;
                }

                const results = searchIndex
                    .filter(item => item.label.toLowerCase().includes(query))
                    .slice(0, 8);

                if (results.length === 0) {
                    autocompleteDropdown.style.display = 'none';
                    return;
                }

                autocompleteDropdown.innerHTML = results.map(item => {
                    const emoji = item.type === 'deity' ? 'üî•' : 
                                 item.type === 'mood' ? 'üåô' : 'üè∑Ô∏è';
                    return `
                        <div class="autocomplete-item" data-node-id="${item.id}">
                            <span class="autocomplete-label">${emoji} ${item.label}</span>
                            <span class="autocomplete-count">(${item.count} verses)</span>
                        </div>
                    `;
                }).join('');

                autocompleteDropdown.style.display = 'block';

                autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const nodeId = item.dataset.nodeId;
                        const targetNode = nodes.find(n => n.id === nodeId);
                        if (targetNode) {
                            selectNode(targetNode);
                            searchInput.value = '';
                            autocompleteDropdown.style.display = 'none';
                        }
                    });
                });
            });

            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                    autocompleteDropdown.style.display = 'none';
                }
            });

            document.getElementById('zoom-in').addEventListener('click', () => {
                svg.transition().duration(300).call(zoom.scaleBy, 1.3);
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                svg.transition().duration(300).call(zoom.scaleBy, 0.7);
            });

            document.getElementById('reset-view').addEventListener('click', () => {
                resetNetworkView();
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(
                        document.getElementById('viz-container').clientWidth / 2,
                        document.getElementById('viz-container').clientHeight / 2
                    ).scale(1)
                );
            });

            document.getElementById('modal-close').addEventListener('click', closeVerseModal);
            document.getElementById('modal-backdrop').addEventListener('click', (e) => {
                if (e.target.id === 'modal-backdrop') closeVerseModal();
            });
            document.getElementById('prev-btn').addEventListener('click', navigateToPrevious);
            document.getElementById('next-btn').addEventListener('click', navigateToNext);
            document.getElementById('random-btn').addEventListener('click', navigateToRandom);

            document.addEventListener('keydown', (e) => {
                if (currentVerseIndex !== -1) {
                    if (e.key === 'Escape') {
                        closeVerseModal();
                    } else if (e.key === 'ArrowLeft') {
                        navigateToPrevious();
                    } else if (e.key === 'ArrowRight') {
                        navigateToNext();
                    } else if (e.key === ' ') {
                        e.preventDefault();
                        navigateToRandom();
                    }
                }
            });

            svg.on('click', (event) => {
                if (event.target === svg.node()) {
                    resetNetworkView();
                }
            });

            document.getElementById('retry-btn').addEventListener('click', () => {
                document.getElementById('error').style.display = 'none';
                document.getElementById('loading').style.display = 'flex';
                location.reload();
            });

            window.addEventListener('resize', () => {
                const container = document.getElementById('viz-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                svg.attr('width', width).attr('height', height);
                simulation.force('center', d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            });
        }

        function setupMobileDrift() {
            let driftInterval;
            let isPaused = false;

            function startDrift() {
                driftInterval = setInterval(() => {
                    if (!isPaused && !selectedNode) {
                        const currentTransform = d3.zoomTransform(svg.node());
                        const dx = (Math.random() - 0.5) * 20;
                        const dy = (Math.random() - 0.5) * 20;
                        
                        svg.transition()
                            .duration(2000)
                            .ease(d3.easeLinear)
                            .call(zoom.transform, 
                                d3.zoomIdentity
                                    .translate(currentTransform.x + dx, currentTransform.y + dy)
                                    .scale(currentTransform.k)
                            );
                    }
                }, 2000);
            }

            svg.on('touchstart', () => {
                isPaused = true;
            });

            svg.on('touchend', () => {
                setTimeout(() => {
                    isPaused = false;
                }, 3000);
            });

            startDrift();
        }

        init();
    </script>
</body>
</html>